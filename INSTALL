#!/bin/bash

# Herhangi bir komut başarısız olursa betiği durdur
set -e

echo "=== Kurulum Betiği Başlatıldı ==="

# === 1. Gerekli Sistem Paketlerini Yükleme ===
echo "Gerekli sistem paketleri (python3-venv) kontrol ediliyor/yükleniyor..."
sudo apt-get update
sudo apt-get install -y python3-venv

# === 2. Sanal Ortam (venv) Oluşturma ve Paketleri Yükleme ===
# Betiğin içinde bulunduğu dizinde çalışıyoruz.
VENV_DIR="ceviri"

if [ ! -d "$VENV_DIR" ]; then
    echo "Sanal ortam '$VENV_DIR' bulunamadı, yeni bir tane oluşturuluyor..."
    python3 -m venv "$VENV_DIR"
else
    echo "Sanal ortam '$VENV_DIR' zaten mevcut, işlem atlanıyor."
fi

echo "Gerekli Python paketleri sanal ortam içine yükleniyor..."
# Doğrudan venv içindeki pip'i çağırarak paketleri yüklüyoruz.
"$VENV_DIR"/bin/pip install --upgrade pip
"$VENV_DIR"/bin/pip install pyperclip pyautogui googletrans==4.0.0rc1 pynput psutil

# === 3. ceviri.py için Gerekli 'python' Dosyasını Oluşturma ===
echo "Python sürüm dosyası oluşturuluyor..."
"$VENV_DIR"/bin/python3 --version > python

# === 4. Crontab'a Komut Ekleme (İsteğe Bağlı, betikte vardı) ===
echo "Crontab ayarlanıyor (sistem başlangıcında otomatik çalışma için)..."

# Değişkenler ile komutu daha okunabilir hale getirelim.
SCRIPT_DIR=$(pwd) # Betiğin çalıştığı mevcut dizin
VENV_PYTHON="$SCRIPT_DIR/$VENV_DIR/bin/python3"
SCRIPT_PATH="$SCRIPT_DIR/ceviri.py"
LOG_FILE="$SCRIPT_DIR/output.log"
CRON_TAG="# CeviriApp"

# Çalıştırılacak tam komut
CRON_JOB="@reboot $VENV_PYTHON $SCRIPT_PATH > $LOG_FILE 2>&1 $CRON_TAG"

# Crontab'ı güncelle
(crontab -l 2>/dev/null | grep -v "$CRON_TAG"; echo "$CRON_JOB") | crontab -

echo ""
echo "============================================================"
echo "KURULUM BAŞARIYLA TAMAMLANDI!"
echo "Uygulamayı Uygulamalar menüsünden başlatabilirsiniz."
echo "Ayrıca, sistemi yeniden başlattığınızda otomatik olarak başlayacaktır."
echo "============================================================"
